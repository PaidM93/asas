<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PriMe SpoT - Video Player</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #111;
        color: #fff;
        text-align: center;
    }
    header {
        background-color: #2196f3;
        padding: 12px;
        font-size: 24px;
        font-weight: bold;
    }
    video {
        width: 90%;
        max-width: 700px;
        margin: 15px auto;
        border-radius: 8px;
        background-color: #000;
    }
    button {
        display: block;
        width: 90%;
        max-width: 700px;
        margin: 8px auto;
        padding: 12px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        color: white;
    }
    .mx { background-color: #9a9ae5; }
    .vlc { background-color: #4caf50; }
    .play { background-color: #ff9800; }
    .download { background-color: #4caf50; }
    .create { background-color: #ffeb3b; color: #333; }
    .share { background-color: #f44336; }
    .file-info {
        background-color: #222;
        padding: 12px;
        margin: 10px auto;
        width: 90%;
        max-width: 700px;
        border-radius: 8px;
        text-align: left;
    }
</style>
</head>
<body>

<header>PriMe SpoT</header>

<!-- Video Poster -->
<img id="poster" src="/stream/poster.jpg" alt="Poster" style="width:90%; max-width:700px; border-radius:8px; margin:10px auto;">

<!-- Video Player -->
<video id="videoPlayer" controls poster="/stream/poster.jpg">
    Your browser does not support HTML5 video.
</video>

<!-- Buttons -->
<button class="mx" onclick="openMX()">â–¶ MX Player</button>
<button class="vlc" onclick="openVLC()">â–¶ VLC Player</button>
<button class="play" onclick="playVideo()">â–¶ Play it</button>
<button class="download" onclick="downloadVideo()">â†“ Download</button>
<button class="create" onclick="createLink()">âœˆ Create Link</button>
<button class="share" onclick="shareVideo()">ðŸ”— Share Now</button>

<!-- File Info -->
<div class="file-info">
    <p><strong>Name:</strong> <span id="fileName">Loading...</span></p>
    <p><strong>Size:</strong> <span id="fileSize">Loading...</span></p>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const fileId = urlParams.get('file_id');
const code = urlParams.get('code');

if(!fileId || !code){
    alert("Invalid file or code!");
}

// Video & download URLs
const videoURL = `/dl/${fileId}?code=${code}`;
const downloadURL = videoURL;

// Update file info
fetch(downloadURL, { method: 'HEAD' })
.then(res => {
    document.getElementById('fileName').innerText = `File ${fileId}.mp4`;
    document.getElementById('fileSize').innerText = (res.headers.get('content-length') / (1024*1024)).toFixed(2) + " MB";
}).catch(console.error);

// MediaSource Streaming for buffering
if ('MediaSource' in window) {
    const video = document.getElementById('videoPlayer');
    const mediaSource = new MediaSource();
    video.src = URL.createObjectURL(mediaSource);

    mediaSource.addEventListener('sourceopen', () => {
        const sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.64001E, mp4a.40.2"');
        fetch(videoURL)
            .then(response => response.arrayBuffer())
            .then(data => {
                sourceBuffer.appendBuffer(data);
            })
            .catch(console.error);
    });
} else {
    // Fallback
    document.getElementById('videoPlayer').src = videoURL;
}

// Button functions
function openMX() {
    window.location.href = `intent:${videoURL}#Intent;package=com.mxtech.videoplayer.ad;end`;
}

function openVLC() {
    window.location.href = `vlc://${videoURL}`;
}

function playVideo() {
    const video = document.getElementById('videoPlayer');
    video.play();
}

function downloadVideo() {
    window.location.href = downloadURL;
}

function createLink() {
    prompt("Copy this link:", `${window.location.origin}/player.html?file_id=${fileId}&code=${code}`);
}

function shareVideo() {
    if(navigator.share){
        navigator.share({
            title: "Watch Video",
            url: `${window.location.origin}/player.html?file_id=${fileId}&code=${code}`
        });
    } else {
        alert("Sharing not supported. Copy the link manually.");
    }
}
</script>

</body>
</html>
